name: Auto-approve docs-only PRs

on:
  pull_request_target:
    types: [opened, synchronize, labeled]

permissions:
  pull-requests: write

jobs:
  auto-approve-docs:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'docs-only')
    steps:
      - name: Check if only docs changed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(gh pr diff "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}" --name-only)
          echo "Changed files:"
          echo "$FILES"
          # Allow: *.md, docs/*, LICENSE, *.txt
          NON_DOC=$(echo "$FILES" | grep -vE '\.(md|txt)$' | grep -vE '^docs/' | grep -vE '^LICENSE$' || true)
          if [ -z "$NON_DOC" ]; then
            echo "docs_only=true" >> "$GITHUB_OUTPUT"
          else
            echo "docs_only=false" >> "$GITHUB_OUTPUT"
            echo "Non-doc files changed: $NON_DOC"
          fi

      - name: Auto-approve
        if: steps.check.outputs.docs_only == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr review "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}" --approve --body "Auto-approved: docs-only change"
